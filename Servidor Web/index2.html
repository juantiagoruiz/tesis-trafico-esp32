<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Mapa de Calor de Trafico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        #heatmapContainer {
            position: relative;
            margin: 0 auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        
        /* Heatmap with background image */
        #heatmap {
            background-image: url('mapa_trafico2.PNG');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            height: 642px;
            width: 100%;
            max-width: 1143px;
            position: relative;
            border-radius: 6px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 900px) {
            #heatmap {
                height: 400px;
            }
        }
        
        @media (max-width: 600px) {
            #heatmap {
                height: 300px;
            }
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 5px;
        }
        .status h3 {
            margin: 0 0 10px 0;
            color: #0c5460;
        }
        .sensor-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .sensor-card {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            min-width: 120px;
            text-align: center;
        }
        .traffic-level {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 3px;
            color: white;
        }
        .level-0 { background-color: #28a745; }
        .level-30 { background-color: #ffc107; color: #000; }
        .level-70 { background-color: #fd7e14; }
        .level-100 { background-color: #dc3545; }
        
        .legend {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .low { background: rgba(0, 255, 0, 0.6); }
        .medium { background: rgba(255, 255, 0, 0.6); }
        .high { background: rgba(255, 165, 0, 0.6); }
        .critical { background: rgba(255, 0, 0, 0.6); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö¶ Mapa de Calor de Trafico en Tiempo Real</h1>
        <div id="heatmapContainer">
            <div id="heatmap"></div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color low"></div>
                <span>Trafico Bajo (0-30%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color medium"></div>
                <span>Trafico Medio (31-60%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color high"></div>
                <span>Trafico Alto (61-80%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color critical"></div>
                <span>Trafico Critico (81-100%)</span>
            </div>
        </div>
        
        <div class="status">
            <h3>üìä Estado actual de trafico</h3>
            <div class="sensor-info" id="sensorInfo">
                <!-- Sensor data will be populated here -->
            </div>
        </div>
        <div class="status">
            <p><strong>Estado de conexion:</strong> <span id="connectionStatus">Conectando...</span></p>
            <p><strong>Ultima actualizacion:</strong> <span id="lastUpdate">Nunca</span></p>
        </div>
    </div>
    
    <script src="heatmap.min.js"></script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Get the heatmap container element by ID
            var heatmapContainer = document.getElementById('heatmap');
            
            // Check if element exists before creating heatmap
            if (!heatmapContainer) {
                console.error('Heatmap container with id "heatmap" not found!');
                return;
            }
            
            console.log('Heatmap container found, creating heatmap instance...');
            
            // Create heatmap instance with proper configuration
            var heatmapInstance = h337.create({
                container: heatmapContainer,
                maxOpacity: 0.6,
                minOpacity: 0,
                radius: 40,
                blur: 0.75,
                // Custom gradient for traffic visualization
                gradient: {
                    0.0: 'rgba(0, 255, 0, 0)',      // Transparent green for no traffic
                    0.2: 'rgba(0, 255, 0, 0.5)',    // Light green for low traffic
                    0.4: 'rgba(255, 255, 0, 0.6)',  // Yellow for medium traffic
                    0.6: 'rgba(255, 165, 0, 0.7)',  // Orange for high traffic
                    0.8: 'rgba(255, 0, 0, 0.8)',    // Red for very high traffic
                    1.0: 'rgba(139, 0, 0, 0.9)'     // Dark red for critical traffic
                }
            });
            
            // Define your sensor locations at the top of your script or in a separate config
			var sensorLocations = [
			// Format: {id, x, y, name/description}
			<!-- {id: 'sensor_1', x: 130, y: 180, name: 'Heroes de Malvinas y Av. Peron', priority: 'high'}, -->
			{id: 'sensor_2', x: 665, y: 105, name: 'Heroes de Malvinas y Sarmiento', priority: 'high'},
			{id: 'sensor_3', x: 398, y: 145, name: 'Heroes de Malvinas y San Juan', priority: 'medium'},
			{id: 'sensor_4', x: 190, y: 550, name: 'Junin y Av. Peron', priority: 'high'},
			{id: 'sensor_5', x: 695, y: 420, name: 'Republica del Libano y Sarmiento', priority: 'high'},
			{id: 'sensor_6', x: 150, y: 173, name: 'Heroes de Malvinas y Av. Peron EO', priority: 'medium'},
			{id: 'sensor_7', x: 130, y: 160, name: 'Peron y Heroes de Malvinas NS', priority: 'low'},
			{id: 'sensor_8', x: 135, y: 190, name: 'Peron y Heroes de Malvinas SN', priority: 'low'},
			<!-- {id: 'sensor_9', x: 504, y: 480, name: 'Park Entrance', priority: 'low'} -->
			];

	async function generateTrafficData() {
    var points = [];
    var max = 100;
    
    try {
        // Fetch real sensor data from ESP32
        const response = await fetch('/api/sensors');
        const sensorData = await response.json();
        
        console.log('Received sensor data:', sensorData);
        
        // Map sensor data to your defined sensor locations
        sensorLocations.forEach(function(sensor) {
		// Look up the API‚Äêprovided intensity by sensor.id key, fall back to 50 if undefined/null
            var intensity = sensorData[sensor.id] ?? 50;
            
                        
            // Ensure intensity is within valid range (0-100)
            intensity = Math.max(0, Math.min(100, intensity));
            
            points.push({
                x: Math.floor(sensor.x),
                y: Math.floor(sensor.y),
                value: Math.floor(intensity),
                sensorId: sensor.id,
				name: sensor.name
            });
        });
        
    } catch (error) {
        console.error('Failed to fetch sensor data, using fallback values:', error);
        
        // Fallback to original random generation if API fails
        sensorLocations.forEach(function(sensor) {
            var baseIntensity, radius;
            
            switch(sensor.priority) {
                case 'high':
                    baseIntensity = 80 + Math.random() * 20;
                    break;
                case 'medium':
                    baseIntensity = 50 + Math.random() * 25;
                    break;
                case 'low':
                    baseIntensity = 25 + Math.random() * 20;
                    break;
                default:
                    baseIntensity = 50;
            }
            
            var val = baseIntensity + (Math.random() * 20 - 10);
            val = Math.max(10, Math.min(100, val));
            
            points.push({
                x: Math.floor(sensor.x),
                y: Math.floor(sensor.y),
                value: Math.floor(val),
                sensorId: sensor.id,
				name: sensor.name
            });
        });
    }
    
			console.log('Generated', points.length, 'traffic data points');
			return { max: max, data: points };
			}
            
            // Function to update sensor info display
            function updateSensorInfo(data) {
                var sensorInfo = document.getElementById('sensorInfo');
                var now = new Date().toLocaleTimeString();
                
                // Update status
                document.getElementById('lastUpdate').textContent = now;
                document.getElementById('connectionStatus').textContent = 'Conectado ‚úÖ';
                
                // Clear previous sensor cards
                sensorInfo.innerHTML = '';
                
                // Get top traffic points
                var sortedPoints = data.data.slice().sort(function(a, b) {
                    return b.value - a.value;
                });
                var topPoints = sortedPoints.slice(0, 6);
                
                topPoints.forEach(function(point, index) {
                    var card = document.createElement('div');
                    card.className = 'sensor-card';
                    
                    var level = '';
                    var levelClass = '';
                    if (point.value >= 80) {
                        level = 'Critico';
                        levelClass = 'level-100';
                    } else if (point.value >= 60) {
                        level = 'Alto';
                        levelClass = 'level-70';
                    } else if (point.value >= 30) {
                        level = 'Medio';
                        levelClass = 'level-30';
                    } else {
                        level = 'Bajo';
                        levelClass = 'level-0';
                    }
                    
                    card.innerHTML = `
                        <div><strong>${point.name}</strong></div>
						<!-- <div><strong>Zone ${index + 1}</strong></div> -->
                        <div>Trafico: ${point.value}%</div>
                        <div class="traffic-level ${levelClass}">${level}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            (${point.x}, ${point.y})
                        </div>
                    `;
                    
                    sensorInfo.appendChild(card);
                });
            }
            
            async function initializeHeatmap() {
				console.log('Initializing heatmap with data...');
				try {
					const initialData = await generateTrafficData();
					console.log('Resolved data:', initialData);
					heatmapInstance.setData(initialData);
					updateSensorInfo(initialData);
					console.log('Heatmap initialized successfully!');
				} catch (err) {
					console.error('Error getting initial data:', err);
				}
			}

			// Kick it off
			setTimeout(initializeHeatmap, 500);
            
            setInterval(async () => {
				console.log('Updating heatmap data...');
				try {
					const newData = await generateTrafficData();
					console.log('Resolved newData:', newData);
					heatmapInstance.setData(newData);
					updateSensorInfo(newData);
				} catch (err) {
					console.error('Error updating data:', err);
				}
			}, 8000);
            
            // Handle window resize
            window.addEventListener('resize', function() {
				setTimeout(async function() {
					console.log('Window resized, updating heatmap...');
					try {
						const newData = await generateTrafficData();
						console.log('Resolved newData:', newData);
						heatmapInstance.setData(newData);
						updateSensorInfo(newData);
					} catch (err) {
						console.error('Error generating data on resize:', err);
					}
				}, 200);
			});
		});
	</script>
</body>
</html>